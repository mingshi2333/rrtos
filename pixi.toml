[workspace]
authors = ["mingshi2333 <akashi_asuka@outlook.com>"]
channels = ["conda-forge"]
name = "rtos"
platforms = ["linux-64"]
version = "0.1.0"
preview = ["pixi-build"]                             # Enable Source Build preview feature

[dependencies]
cmake = "*"
ninja = "*"
clang = ">=18"
lld = "*"
llvm-tools = "*"  # Provides llvm-ar, llvm-strip, etc.
python = ">=3.11"
meson = ">=0.61"
pyyaml = ">=6.0.3,<7"

[target.linux-64.dependencies]
# GCC cross-compiler is not available on conda-forge, using Clang


[tasks]
# === Dependency Management Tasks ===
# Initialize IREE submodule
init-iree = "test -d third_party/iree/.git || git submodule update --init --recursive third_party/iree"

# Build Picolibc package (pixi build will automatically choose the correct package)
build-picolibc = "pixi build"

# Legacy build script (deprecated, kept for backward compatibility)
build-picolibc-legacy = "sh scripts/build_picolibc.sh"

clean = "rm -rf build"

# === Model Conversion Tasks ===
# Usage: pixi run convert-model <tflite_path> <output_name>
# Example: pixi run convert-model zoo/models/medium/mobilenet_v2_0.35_128_int8.tflite mobilenet_v2_035_128
convert-model = "cd zoo/scripts && ./tflite_to_iree_c.sh -a rv32"
size = "llvm-size -A -x build/mobilenet_test"
rebuild = { depends-on = ["clean", "configure", "build"] }

sim-simple = "qemu-system-riscv64 -machine virt -nographic -bios none -kernel build/iree_simple_test"
sim-mobilenet = "qemu-system-riscv64 -machine virt -nographic -bios none -kernel build/mobilenet_test"
sim-renode = "renode --disable-xwt --console -e 's @test_renode.resc; sleep 5; quit'"

verify = { depends-on = ["build", "sim-simple"] }

[feature.rv64.dependencies]
picolibc-rv64 = { path = "packages/picolibc-rv64" }

[feature.rv64.tasks]
configure = "cmake -B build -DCMAKE_TOOLCHAIN_FILE=cmake/riscv64-pixi.cmake -DCMAKE_BUILD_TYPE=MinSizeRel"
build = "cmake --build build"
sim-mobilenet = "qemu-system-riscv64 -machine virt -nographic -bios none -kernel build/mobilenet_test"
sim-renode = "renode --console --disable-xwt scripts/simulation/mobilenet_test.resc"

[feature.rv32.dependencies]
picolibc-rv32 = { path = "packages/picolibc-rv32" }
compiler-rt = ">=21.1.8,<22"

[feature.rv32.tasks]
configure = "cmake -B build -DCMAKE_TOOLCHAIN_FILE=cmake/riscv32-pixi.cmake -DARCH_BITS=32 -DARCH=riscv -DCMAKE_BUILD_TYPE=MinSizeRel"
configure-flash = "cmake -B build -DCMAKE_TOOLCHAIN_FILE=cmake/riscv32-pixi.cmake -DARCH_BITS=32 -DARCH=riscv -DCMAKE_BUILD_TYPE=MinSizeRel -DLINKER_SCRIPT=arch/riscv/link_flash.ld"
build = "cmake --build build"
sim-ai = "qemu-system-riscv32 -machine virt -nographic -m 4M -bios none -kernel build/apps/ai_demo/ai_demo"
sim-renode-ai = "renode --console --disable-xwt scripts/simulation/ai_demo_rv32.resc"
test-registry = "timeout 15 qemu-system-riscv32 -machine virt -nographic -m 4M -bios none -kernel build/apps/ai_registry_test/ai_registry_test"
ai-gen = { cmd = "python3 scripts/ai_codegen.py", description = "Generate AI model registry and wrappers from ai_models.yaml" }

# Alias for backward compatibility
sim-mobilenet = "pixi run sim-qemu"

[environments]
default = ["rv64"]
rv64 = ["rv64"]
rv32 = ["rv32"]
