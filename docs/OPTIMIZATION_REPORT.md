# Final Optimization Report: AI-RTOS System (RV32)
**Date:** January 20, 2026
**Target:** `ai_demo` (YOLOv1-Tiny INT8) on Custom RISC-V RTOS

---

## 1. Optimization Achievements

We successfully optimized the system for a resource-constrained RISC-V 32-bit MCU (512KB Flash / 192KB RAM).

| Metric | Initial State (RV64) | Optimized State (RV32) | Improvement |
| :--- | :--- | :--- | :--- |
| **Flash (Code)** | ~454 KB | **~509 KB** | +55 KB (Due to -O3/-Oz expansion & 32-bit overhead) |
| **RAM (Total)** | ~270 KB (Est.) | **~162 KB** | **~40% Reduction** |
| **Input Latency** | High (Copy overhead) | **Zero-Copy** | Eliminated 108KB memcpy |
| **Stack Usage** | ~32KB (AI) + Sys | **Same** | Maintained safety margin |

### Key Optimizations Applied:
1.  **Zero-Copy Input**: Refactored `ai_model.c` to import the input buffer directly into IREE, saving **108 KB** of runtime heap.
2.  **Direct HAL Device**: Removed `iree_hal_driver` abstraction, saving ~3KB Flash and reducing initialization complexity.
3.  **Compiler Optimization**: Enabled `-Oz` (MinSize) and `-Wl,--strip-all` to minimize binary size.
4.  **Hardware Fixes**: Corrected CLINT/UART base addresses and enabled RISC-V Vector (RVV) support.

---

## 2. Final Resource Usage

### 2.1 Flash (ROM) - ~509 KB
*   **Capacity Limit**: 512 KB (99.5% Utilized) - **CRITICAL**
*   **Breakdown**:
    *   **AI Model Weights**: ~301 KB (60%)
    *   **IREE Runtime**: ~140 KB (27%)
    *   **RTOS/Libc**: ~68 KB (13%)

### 2.2 RAM (Memory) - ~162 KB
*   **Breakdown**:
    *   **Input Buffer**: 108 KB (66%) - 192x192 RGB
    *   **AI Stack**: 32 KB (20%) - Reserved for VM
    *   **System Stack**: 16 KB (10%)
    *   **Global Data**: ~6 KB (4%)

---

## 3. Simulation & Verification

### 3.1 QEMU Simulation
*   **Command**: `qemu-system-riscv32 -machine virt -cpu rv32,v=true`
*   **Status**: **SUCCESS**
*   **Output**:
    ```text
    Booting RTOS...
    [AI] Opt Init OK
    Run AI...
    AI Execution Time: 5723 ms
    Result: Class 208, Confidence 125
    SUCCESS!
    ```

### 3.2 Recommendations
1.  **Flash Space**: The current 2.5KB margin is unsafe for production.
    *   **Action**: Use a 1MB Flash chip OR Prune the model further (reduce channels/layers).
2.  **RAM Headroom**: 30KB free RAM is healthy for this class of device.
    *   **Action**: If more RAM is needed, switch input to Grayscale (saves 72KB).

---

## 4. Renode Simulation Results
*   **Status**: **Partial Success**
*   **Boot & Init**: Confirmed working. `[AI] Opt Init OK`.
*   **Inference**: Failed with `Illegal Instruction (mcause=0x2)` at `0x800218dc`.
*   **Analysis**: The crash occurs inside the IREE model execution. The instruction `0xe194` triggers an "Unknown floating point instruction" error in Renode. This indicates a discrepancy between the binary's Vector/Float instructions (generated by LLVM -Oz) and Renode's CPU model support.
*   **Conclusion**: QEMU (`rv32,v=true`) is currently the reliable simulator for this Vector-enabled build. Renode confirms the system initialization and UART drivers are functioning correctly on a second platform.
